<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags for character encoding and viewport settings -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    
    <!-- External CSS and library imports -->
    <link rel="stylesheet" 
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>

.toast {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    animation: slideInRight 0.5s ease-out;
}

.toast.fade-out {
    opacity: 0;
    transition: opacity 0.5s ease-out;
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}
    
        /* Base body styles */
        body {
            display: flex;
            background: url('./Images for site/study_theme_wallpaper.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            font-family: "Poppins", sans-serif;
            margin: 0;
            height: 100vh;
        }

        /* Header styles */
        .header {
            position: fixed;
            top: 0;
            left: 300px; /* space for the fixed sidebar */
            right: 0;
            height: 50px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.6); /* Adjust background for contrast */
            color: #fff;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Back button styling */
        .header .back-button {
            display: flex;
            align-items: center; /* Center-align the icon and text */
            gap: 10px; /* Space between icon and text */
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            font-size: 16px;
        }

        .header .back-button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .header .back-button i {
            font-size: 18px; /* Adjust the size of the icon */
        }

        /* Account button styling */
        .header .account-button {
            display: flex;
            align-items: center; /* Ensures icon and text align properly */
            gap: 10px;
            background: #f39c12;
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease, color 0.3s ease;
            margin-left: auto;
        }

        .header .account-button:hover {
            background: #d35400; /* Darker orange on hover */
            color: #fff;
        }

        .header .account-button i {
            font-size: 18px;
        }

        /* Alternative account button style */
        .account-button {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.938);
            color: #05040433;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease color 0.3s ease;
        }

        .account-button:hover {
            background: rgba(0, 0, 0, 0.4);
            color: #0e0505;
        }

        /* Dropdown menu styling */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 300px;
            color: #fff;
            z-index: 1100;
        }

        .dropdown-menu.active {
            display: block;
        }

        /* User info section in dropdown */
        .dropdown-menu .user-info {
            margin-bottom: 10px;
        }

        .dropdown-menu .user-info p {
            margin: 5px 0;
        }

        .dropdown-menu .role {
            font-weight: bold;
            color: #ffd700;
        }

        /* Online status indicator */
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #fff;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background-color: #32cd32;
            border-radius: 50%;
            box-shadow: 0 0 10px #32cd32, 0 0 20px #32cd32;
            animation: pulse 1.5s infinite;
        }

        /* Keyframes for the glowing pulse */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 10px #32cd32, 0 0 20px #32cd32;
            }
            50% {
                transform: scale(1.2);
                box-shadow: 0 0 15px #32cd32, 0 0 30px #32cd32;
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 10px #32cd32, 0 0 20px #32cd32;
            }
        }

        /* Logout button styling */
        .logout-button {
            width: 100%;
            padding: 10px;
            background-color: rgba(255, 0, 0, 0.8); /* Red color for emphasis */
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-button:hover {
            background-color: rgba(255, 0, 0, 1); /* Darker red on hover */
        }

        .logout-button i {
            font-size: 16px;
        }

        /* Sidebar styling */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        }

        /* Logo styling in sidebar */
        .sidebar .logo {
            position: relative; /* Adjust positioning */
            text-align: left;
            margin-bottom: 20px; /* Ensure enough spacing below the logo */
            margin-top: 0;
        }

        .sidebar .logo img {
            max-width: 290px;
            max-height: 400px;
            margin: 0;
            border-radius: 0;
            display: block;
            position: absolute;
            left: -15px; /* Adjust size and move further left */
            top: 0px;
        }

        /* Separator line styling */
        .sidebar .separator {
            width: 105%;
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
            margin: 79px 0; /* Space above and below the separator */
            left: -100px; /* Adjusted to create separation from sidebar content */
        }

        /* Sidebar navigation links */
        .sidebar a {
            text-decoration: none;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 25px;
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
        }

        /* Hover effect for links */
        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
            background-image: linear-gradient(45deg, #FFE8A2, #70ddee);
            color: #090404;
            transition: all 0.3s ease-in-out;
        }

        .sidebar a i {
            font-size: 20px;
        }

        /* Main content container */
        .main-content {
            margin-left: 300px; /* space for the fixed sidebar */
            padding: 80px 40px 20px; /* top padding pushes below the fixed header */
            display: flex;
            flex-direction: column;
            align-items: center; /* center items horizontally within .main-content */
            gap: 30px;
            width: calc(100% - 300px);
        }

        /* Dashboard title styling */
        .dashboard-title {
            text-align: center; /* Center the heading */
            font-size: 48px; /* Adjust as needed */
            color: #333; /* Text color */
            margin: 20px 0 30px; /* Spacing: 60px on top, 30px on bottom */
            background: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 10px; /* Rounded corners */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            display: inline-block; /* So background/padding only wraps text */
        }

        /* Overview section layout */
        .overview {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1200px;
        }

        /* Basic bubble styling */
        .bubble {
            width: calc(50% - 20px);
            min-width: 280px;
            height: auto;
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .bubble:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .bubble i {
            font-size: 24px;
            color: #f39c12;
        }

        .bubble h3 {
            margin: 10px 0;
            font-size: 20px;
        }

        .bubble ul {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .bubble ul li {
            margin: 5px 0; /* If stacked vertically, add spacing between them */
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            width: 100%;
            height: 150px; /* Adjust height as needed */
            margin: 10px 0;
        }

        .chart-center-text {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        #taskProgressChart {
            width: 100% !important;
            height: 100% !important; /* Adjust the canvas size */
        }

        /* Bubble button styling */
        .bubble button {
            background: #f39c12;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }

        .bubble button:hover {
            background: #d35400;
        }
    </style>
</head>

<body>
    <!-- Header with account button -->
    <div class="header">
        <div class="account-button" onclick="toggleDropdown()">
            <i class='bx bxs-user-circle'></i>
            <span>Account</span>
        </div>
    </div>

    <!-- Sidebar navigation -->
    <div class="sidebar">
        <div class="logo">
            <img src="Logo.png" alt="Logo">
        </div>

        <div class="separator"></div>

        <!-- Navigation links -->
        <a href="Dashboard.html">
            <i class='bx bxs-dashboard'></i>
            <span>Dashboard</span>
        </a>

        <a href="Group-Management.html">
            <i class='bx bxs-user'></i>
            <span>Groups</span>
        </a>

        <a href="Projects.html">
            <i class='bx bxs-folder'></i>
            <span>Projects</span>
        </a>

        <a href="To-Do-List.html">
            <i class='bx bx-task'></i>
            <span>Tasks</span>
        </a>

        <a href="Calendar.html">
            <i class='bx bx-calendar'></i>
            <span>Calendar</span>
        </a>

        <a href="settings2.html">
            <i class='bx bxs-cog'></i>
            <span>Settings</span>
        </a>
    </div>

    <!-- Account dropdown menu -->
    <<!-- Account dropdown menu -->
<div class="dropdown-menu" id="dropdown-menu" aria-expanded="false">
    <div class="user-info">
        <p>Name: <span id="user-name">Loading...</span></p>
        <p>Email: <span id="user-email">Loading...</span></p>
        <p class="status">
            <span class="status-dot"></span> Online
        </p>
    </div>
    <p class="role">Role: <span id="user-role">Loading...</span></p>
    <button class="logout-button" onclick="logout()">
        <i class='bx bx-log-out'></i> Log Out
    </button>
</div>

    <!-- Main content area -->
    <div class="main-content">
        <h1 class="dashboard-title">Dashboard</h1>

        <!-- Overview section with bubble cards -->
        <div class="overview">
            <!-- Upcoming Deadlines bubble -->
            <div class="bubble">
                <i class='bx bx-calendar'></i>
                <h3>Upcoming Deadlines</h3>
                <ul id="upcoming-deadline-list">
                    <li>Loading tasks...</li> <!-- temporary message -->
                </ul>
                <button onclick="viewAllTasks()">View All Tasks</button>
            </div>
            

            <!-- Task Progress bubble with chart -->
            <div class="bubble">
                <i class='bx bx-trending-up'></i>
                <h3>Task Progress</h3>
                <div class="chart-container">
                    <canvas id="taskProgressChart"></canvas>
                    <div class="chart-center-text" id="chartCenterText">60%</div>
                </div>
                <button onclick="viewProgress()">View Details</button>
            </div>

            <!-- Study Groups bubble -->
            <div class="bubble">
                <i class='bx bx-group'></i>
                <h3>Study Groups</h3>
                <ul id="study-group-list">
                    <li>Loading groups...</li>
                </ul>                
                <button onclick="viewAllGroups()">View All Groups</button>
            </div>

            <!-- Recent Activity bubble -->
            <div class="bubble">
                <i class='bx bx-bell'></i>
                <h3>Recent Activity</h3>
                <ul>
                    <li>You completed "Math Homework"</li>
                    <li>Tolu: completed "Science Project"</li>
                </ul>
                <button onclick="viewAllActivity()">View All Activity</button>
            </div>
        </div>
    </div>

    <div id="success-toast" class="toast">
        <i class='bx bxs-check-circle toast-icon'></i>
        <p>Login Successful! Welcome to your dashboard.</p>
    </div>
    

    <script>

    let taskProgressChart; // will be initialized later
    let chartCenterText;   // DOM element reference

        
async function loadUpcomingDeadlines() {
    const token = localStorage.getItem('access_token');
    if (!token) return;

    try {
        const response = await fetch('http://127.0.0.1:8000/tasks/get-all-tasks/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('Failed to fetch tasks');

        const tasks = await response.json();
        const upcomingList = document.getElementById('upcoming-deadline-list');
        upcomingList.innerHTML = '';

        const today = new Date();

        // âœ… Count completed vs total
        const totalTasks = tasks.length;
        const completedTasks = tasks.filter(task => task.status === 'completed').length;
        const remainingTasks = totalTasks - completedTasks;
        const completionPercentage = totalTasks === 0 ? 0 : Math.round((completedTasks / totalTasks) * 100);

        // âœ… Update the doughnut chart
        updateChart(completedTasks, remainingTasks, completionPercentage);

        // âœ… Show top 5 upcoming deadlines
        const upcoming = tasks
            .filter(task => task.due_date && task.status !== 'completed')
            .sort((a, b) => new Date(a.due_date) - new Date(b.due_date))
            .slice(0, 5);

        if (upcoming.length === 0) {
            upcomingList.innerHTML = '<li>No upcoming tasks ðŸŽ‰</li>';
            return;
        }

        upcoming.forEach(task => {
            const dueDate = new Date(task.due_date);
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let label = '';
            if (diffDays < 0) label = `Overdue by ${Math.abs(diffDays)} day(s)`;
            else if (diffDays === 0) label = 'Due Today';
            else if (diffDays === 1) label = 'Due Tomorrow';
            else label = `Due in ${diffDays} days`;

            const li = document.createElement('li');
            li.textContent = `${task.title} â€“ ${label}`;
            upcomingList.appendChild(li);
        });

    } catch (err) {
        console.error('Failed to load upcoming deadlines:', err);
    }
}

async function loadStudyGroups() {
    const token = localStorage.getItem('access_token');
    if (!token) return;

    try {
        const response = await fetch('http://127.0.0.1:8000/groups/api/groups/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('Failed to fetch study groups.');

        const groups = await response.json();
        const groupList = document.getElementById('study-group-list');
        groupList.innerHTML = '';

        if (groups.length === 0) {
            groupList.innerHTML = '<li>No groups yet</li>';
            return;
        }

        groups.slice(0, 5).forEach(group => {
            const li = document.createElement('li');
            li.textContent = group.group_name;
            groupList.appendChild(li);
        });

    } catch (error) {
        console.error('Error loading groups:', error);
        const groupList = document.getElementById('study-group-list');
        groupList.innerHTML = '<li>Error loading groups</li>';
    }
}



        document.addEventListener("DOMContentLoaded", function () {
        const successToast = document.getElementById("success-toast");

        // Check if login was successful
        if (sessionStorage.getItem("showSuccess") === "true") {
            successToast.style.display = "block";  // Show success message
            sessionStorage.removeItem("showSuccess");  // Clear flag

            // Fade out after 3 seconds (3000ms)
            setTimeout(() => {
                successToast.classList.add("fade-out");
                setTimeout(() => {
                    successToast.style.display = "none";  // Hide completely after fade-out
                }, 500); // Adjust to match fade-out animation duration
            }, 3000);
        }
        loadUpcomingDeadlines();
        loadStudyGroups();
        });


        // Toggle dropdown menu visibility
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdown-menu');
            const isExpanded = dropdown.getAttribute('aria-expanded') === 'true';
            dropdown.classList.toggle('active');
            dropdown.setAttribute('aria-expanded', !isExpanded);
        }



        // Function to fetch and display user profile
        async function fetchUserProfile() {
    try {
        const response = await fetch('http://127.0.0.1:8000/api/user-profile-drop/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}` // Use JWT token for authentication
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch user profile');
        }

        const data = await response.json();

        // Update the dropdown with user data
        document.getElementById('user-name').textContent = `${data.first_name} ${data.last_name}`;
        document.getElementById('user-email').textContent = data.email;
        document.getElementById('user-role').textContent = data.role || 'User'; // Default to 'User' if role is not provided
    } catch (error) {
        console.error('Error fetching user profile:', error);

        // Display an error message in the dropdown
        document.getElementById('user-name').textContent = 'Error loading user data';
        document.getElementById('user-email').textContent = 'Please try again later';
        document.getElementById('user-role').textContent = 'User'; // Default role
    }
}

// Call the function when the page loads
document.addEventListener('DOMContentLoaded', fetchUserProfile);

        // Redirect to the login page
        function logout() {
            window.location.href = '/Frontend/Login%20/Login.html';
        }

 // Check if the user is authenticated
 function isAuthenticated() {
            return localStorage.getItem('access_token') !== null;
        }

        // Redirect to login if not authenticated
        if (!isAuthenticated()) {
            window.location.href = '/Frontend/Login%20/Login.html';
        }

        function updateChart(completed, remaining, percent = 0) {
    if (!taskProgressChart) return;
    taskProgressChart.data.datasets[0].data = [completed, remaining];
    taskProgressChart.update();
    chartCenterText.textContent = `${percent}%`;
}

function viewAllTasks() {
    window.location.href = 'http://127.0.0.1:5500/Frontend/To-Do-List.html#task-list';
}

function viewAllGroups() {
    window.location.href = 'http://127.0.0.1:5500/Frontend/Group-Management.html#group-list';
}

function viewProgress() {
    window.location.href = 'http://127.0.0.1:5500/Frontend/To-Do-List.html#task-list';
}


        // Get piechart (Task progress)
        document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('taskProgressChart').getContext('2d');
    chartCenterText = document.getElementById('chartCenterText');

    taskProgressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Remaining'],
            datasets: [{
                data: [0, 1], // Start with empty chart
                backgroundColor: ['#f39c12', '#e0e0e0'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    enabled: true
                }
            }
        }
    });

    

        }   
        
    
    );
    </script>
</body>
</html>
